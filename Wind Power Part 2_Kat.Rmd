---
title: "R Notebook"
output: html_notebook
---

## Read the data tuno.txt into R.
The data is read, and the first few lines of the code is shown.
```{r}
data <- read.delim("tuno.txt",header = TRUE, sep = " ", dec = ".")
data$pow.obs.norm<-(data$pow.obs)/5000
head(data,6)
```


### 1. Formulate an initial model

The model that we consider is:
$$y=f(w_s)=\beta_0+\beta_1w_s+\beta_2w_s^2$$
Where y is the observed power production and f is a function of wind speed.
```{r}
mod1=lm(pow.obs.norm~ ws30+I(ws30^2), data=data)
summary(mod1)
AIC(mod1)
```
All parameters are significant.

```{r}
library(car)
qqPlot(mod1$residuals)
```

### 2. You might consider non-normal models and/or normal model with data transformation. Further you might consider including wind direction. You should devellop a suited model for prediction of daily power produAction. 

#### Models without tranformation 
```{r}
mod2=glm(pow.obs.norm~ ws30,family=Gamma,  data=data)
summary(mod2)
AIC(mod2)
```

```{r}
qqPlot(mod2$residuals)
```
```{r}
library(betareg)
mod8=betareg(pow.obs.norm~ ws30, data=data)
summary(mod8)
AIC(mod8)
```

```{r}
qqPlot(mod8$residuals)
```


## Models using transformation 1, from project 1:
Optimer lambda således at residualerne fra modellen best fitter en normalfordeling. 


#### Wind Speed and Wind Speed Squared
```{r, warning=FALSE}
trans1 <- function(lambda,y){
    y.l <- 1/lambda*log((y^lambda)/(1-y^lambda))
    return(y.l)}

## profile likelihood for lambda
lp.lambda1 <- function(lambda,y){
    mod <- lm(trans1(lambda,y)~data$ws30+I(data$ws30^2))
    length(y)/2*log(summary(mod)$sigma^2) - sum(log(abs(1/(y*(1 - y^lambda)))))
    }

plot(seq(0.01,1,0.01), sapply(seq(0.01,1,0.01), lp.lambda1, y=data$pow.obs.norm))

lp.lambda1(1/1, data$pow.obs.norm)
(opt.lambda.trans1=optimize(lp.lambda1,c(0,1),y=data$pow.obs.norm))

```
```{r}
mod3=glm(trans1(opt.lambda.trans1$minimum,data$pow.obs.norm)~ ws30+I(data$ws30^2),family=gaussian,  data=data)
summary(mod3)
AIC(mod3)
qqPlot(mod3$residuals)
```
We have tried to add a third order term, but it did not improve the model as it was not significant.

#### Wind speed, Wind speed squared and cosine of wind direction
```{r}
#Forsøg med sin og cos til wd

trans1 <- function(lambda,y){
    y.l <- 1/lambda*log((y^lambda)/(1-y^lambda))
    return(y.l)}

## profile likelihood for lambda
lp.lambda1 <- function(lambda,y){
    mod <- lm(trans1(lambda,y)~data$ws30+I(data$ws30^2)+cos(data$wd30))
    length(y)/2*log(summary(mod)$sigma^2) - sum(log(abs(1/(y*(1 - y^lambda)))))
    }

#plot(seq(0.01,1,0.01), sapply(seq(0.01,1,0.01), lp.lambda1, y=data$pow.obs.norm))

lp.lambda1(1/1, data$pow.obs.norm)
(opt.lambda.trans1=optimize(lp.lambda1,c(0,1),y=data$pow.obs.norm))

```
```{r}
library(car)
mod5=glm(trans1(opt.lambda.trans1$minimum,data$pow.obs.norm)~ data$ws30+I(data$ws30^2)+cos(data$wd30),family=gaussian,  data=data)
summary(mod5)
AIC(mod5)
qqPlot(mod5$residuals)
```

#### Wind speed, Wind speed squared and cosine of wind direction
```{r}
#Forsøg med sin og cos til wd

trans1 <- function(lambda,y){
    y.l <- 1/lambda*log((y^lambda)/(1-y^lambda))
    return(y.l)}

## profile likelihood for lambda
lp.lambda1 <- function(lambda,y){
    mod <- lm(trans1(lambda,y)~cos(data$wd30)+sin(data$wd30)+cos(I(data$wd30*2)))
    length(y)/2*log(summary(mod)$sigma^2) - sum(log(abs(1/(y*(1 - y^lambda)))))
    }

#plot(seq(0.01,1,0.01), sapply(seq(0.01,1,0.01), lp.lambda1, y=data$pow.obs.norm))

lp.lambda1(1/1, data$pow.obs.norm)
(opt.lambda.trans1=optimize(lp.lambda1,c(0,1),y=data$pow.obs.norm))

```
```{r}
library(car)
mod6=glm(trans1(opt.lambda.trans1$minimum,data$pow.obs.norm)~cos(data$wd30)+sin(data$wd30)+cos(I(data$wd30*2)),family=gaussian,  data=data)
summary(mod6)
AIC(mod6)
qqPlot(mod6$residuals)
```


### 3. Present the parameters of the final model, this include quantification of the uncertainty of parameters.
```{r}
Confint(mod6)
```


### 4. Give an interpretation of the parameters in the particular this should include presentation of any nonlinear functions (series expansions) of the exploratory variables.


### 5. Present the final model e.g. some graphical presentation of predictions under different scenarios of wind speed and wind direction. 
```{r}

sigma <- sqrt((1/length(data$pow.obs.norm))*sum(data$wd30-mean(data$wd30))^2)
t.quan <- qt(p = 0.975, df=length(data$pow.obs.norm)-4 )
interval_u<-mod6$fitted.values+t.quan*sigma
interval_l<-mod6$fitted.values+t.quan*sigma
#Y.pred.all+t.quan*sqrt(var.Y.pred.all)
```


```{r}
plot(data$wd30,trans1(opt.lambda.trans1$minimum,data$pow.obs.norm))
points(data$wd30,mod6$fitted.values, pch=16, col="Red")   
points(data$wd30,interval_u, col="Red")
#lines(interval_l, col)
```

