---
title: "Assignment Survival Data"
output:
  pdf_document: default
  html_notebook: default
---

#Analysis of binary data

###  Read the Logistic.txt into R.

```{r}
data <- read.delim("Logistic.txt",header = TRUE, sep = "", dec = ".")
data$AIDS_no=data$n-data$AIDS_yes
head(data,2) 

n <- sum(data[,3]) #Antallet af patienter
s <- sum(data[,2]) #Antallet som har AIDS
p <- s/n 
```
The data consist of patients being treated with AZT and the number of patients with AIDS, as well as patients not being treated with AZT and the number of patients having AIDS. It looks like more patients get AIDS if they are not treated with AZT.

### Fitting data to binomial distribution (i.e. consider all data as coming from the same population)
The log-likelihood of the binomial distribution is:
$$l(\theta)=\sum_{k=0}^{n}k\cdot log(\theta)+(n-k)\cdot log(1-\theta)+c(n,k)$$
where n is the number of patients, k is the number of patient with AIDS. Since it is consider as coming from the same population i.e. follow the same distibution, the data is fitted to one binomial distribution.

```{r}

#Formulating the likelihood function
binomial.log.likelihood = function(theta,success,size){
  -(sum(dbinom(x=success,size=size,prob=theta, log=TRUE)))}

(theta.opt=optimize(binomial.log.likelihood, c(0.01,0.99),success=sum(data$AIDS_yes),size=sum(data$n))$minimum)

```

### Fit the Binomial separately to the two distributions and test if there is a difference between the groups.

```{r}
#Theta for patients treated with AZT. This is the probability of having AIDS when treated with AZT. 
(theta_AZT_yes.opt=optimize(binomial.log.likelihood, c(0.01,0.99),x=data$AIDS_yes[1],size=data$n[1])$minimum)

#Theta for patients treated without AZT. This is the probability of having AIDS without treament. 
(theta_AZT_no.opt=optimize(binomial.log.likelihood, c(0.01,0.99),x=data$AIDS_yes[2],size=data$n[2])$minimum)
```

```{r}
library(numDeriv)
H <- hessian(binomial.log.likelihood,theta.opt,success=s,size=n)
H <- hessian(binomial.log.likelihood,theta.opt,success=s,size=n)

#The standard error 
se <- 1/sqrt(H)


#confidence intervallet
p+c(-1,1)*qnorm(0.975)*se1/sqrt(n)
```



The null hypothesis is that the two distributions are equal meaning that if AZT_yes follows $B(m,\pi_x)$ and AZT_no follows $B(n,\pi_y)$ $\pi_x=\pi_y$.
```{r}
x=data$AIDS_yes[1]
y=data$AIDS_no[1]
m=sum(data$AIDS_yes)
n=sum(data$AIDS_no)
N=m+n
t=x+y

#The standard test of equality of proportions is the famous chi-squared test
(chi.squared.test=N*(x*(n-y)-y*(m-x))^2/(m*n*t*(N-t)))

(pchisq(chi.squared.test, df=1, lower.tail=FALSE))
```
With a p-value of 0.008816159 we have strong evidence against the null hypothesis meaning that the two groups does not follow the same distribution.

To proceed with a likelihood analysis, the number of people with AIDS (X) in the group treated with AZT is $B(m,\pi_x)$ and independently the number of people with AIDS (Y)  in the second group is $B(n,\pi_y)$.

On observing x and y the joint likelihood of $(\pi_x,\pi_y)$:
$$L(\pi_x, \pi_y)=\pi_x^x*(1-\pi_x)^{m-x}\pi_y^y(1-\pi_y)^{n-y}$$

The log odds-ratio is defined by:
$$\theta=\log \frac{\pi_{x} /\left(1-\pi_{x}\right)}{\pi_{y} /\left(1-\pi_{y}\right)}$$
```{r}
(theta.compare = log((theta_AZT_yes.opt/(1-theta_AZT_yes.opt))/(theta_AZT_no.opt/(1- theta_AZT_no.opt))))

```
To make a profile likelihood function for $\theta$ as stated above, the eta is calculated:

$$\eta=\log \frac{\pi_{y}}{1-\pi_{y}}$$
With $\eta$ the joint likelihood function for $\theta$ and $\eta$ can be found:

$$L(\theta, \eta)=e^{\theta x} e^{\eta(x+y)}\left(1+e^{\theta+\eta}\right)^{-m}\left(1+e^{\eta}\right)^{-n}$$
The MLE for this likelihood function is:
$$\hat{\theta}=log(\frac{x/(m-x)}{y/(n-y)})$$
Calculate optimal theta for the joint likelihood
```{r}
(that= log(x/(m-x)*(n-y)/y))
se2<- 1/x + 1/(m-x) + 1/y + 1/(n-y)
se<- sqrt(se2)

```

$\hat{\theta}}=-0.721766$
Plot the joint likelihood
```{r}
ehat<- log(y/(n-y))
  #print(c(that,ehat))
  cat('theta-hat=',that,',  se=',se,'\n')

# plots
par(mfrow=c(1,1))
th<- seq(that-2*se,that+3*se,len=30)
et<- seq(ehat-4,ehat+2,len=30)

fun1<- function(theta,eta){
      a <- exp(theta+eta)
      b<- exp(eta)
      x*theta + (x+y)*eta - m*log(1+a) - n*log(1+b)
      }

ll<- outer(th,et,'fun1')
like<- exp(ll-max(ll))

lik1<- apply(like,1,max)
plot(th,lik1,type='n',xlab=expression(theta),
     ylab='Likelihood')
  lines(th,lik1)
  abline(h=.15,lwd=.4)
  abline(v=0)
  title(expression('(b) Profile likelihood'))

```


The null hypothesis is $H_0: \theta=0$. Since $\theta$ is significantly different from zero, the null-hypothesis is rejected and it is concluded that the groups are significantly different from each other. This means that there is a difference in if a patient receives treament with AZT or not. 


### Estimate parameters in the model (p0 probability of AIDS in control group, p1 probability of AIDS in treatment group) and report a confidence interval for the parameter describing the dif- ference, compare with the result above.

The formulas look like a binomial model. This binomial model has the log-likelihood
$$ $$
```{r}

#fit.glm =glm(y~x, family=binomial)
```

#Analysis of the survival time data

```{r}

#Load data
data.time <- read.delim("actg320.txt",header = TRUE, sep = "", dec = ".")
head(data.time,2) 
```

```{r}
#Count number of patient without treatment and without AIDS
(sum(data.time$tx == 0 & data.time$event == 0))
#Count number of patient without treatment and AIDS
(sum(data.time$tx == 0 & data.time$event == 1))
#Count number of patient with treatment and without AIDS
(sum(data.time$tx == 1 & data.time$event == 0))
# Count number of patient with treatment and AIDS
(sum(data.time$tx == 1 & data.time$event == 1))

#Calculating proportions

#No aids out of people without treatment
(sum(data.time$tx == 0 & data.time$event == 0))/sum(data.time$tx == 0)
(sum(data.time$tx == 0 & data.time$event == 1))/sum(data.time$tx == 0)
(sum(data.time$tx == 1 & data.time$event == 0))/sum(data.time$tx == 1)
(sum(data.time$tx == 1 & data.time$event == 1))/sum(data.time$tx == 1)
```
Fit an exponential distribution to all the data. 

```{r}
exp.likelihood=function(rate){
  -sum(dexp(x=data.time$time[data.time$event==1], rate=rate, log=TRUE))- sum(pexp(q=data.time$time[data.time$event==0], lower.tail = FALSE, rate=rate, log=TRUE))
  }


(nlminb(start=0.5,objective = exp.likelihood,lower=0)$par)
#(optimize(exp.likelihood,c(0, 100),maximum=TRUE)$maximum)

```

Fit an exponential distribution to the group that received treatment. 

```{r}

exp.likelihood_no_treat=function(rate){
  -sum(dexp(x=data.time$time[data.time$event==1 & data.time$tx == 0], rate=rate, log=TRUE))- sum(pexp(q=data.time$time[data.time$event==0 & data.time$tx == 0], lower.tail = FALSE, rate=rate, log=TRUE))
}

(nlminb(start=0.5,objective = exp.likelihood_no_treat,lower=0)$par)
(nlminb(start=0.5,objective = exp.likelihood_no_treat,lower=0)$objective)




exp.likelihood_with_treat=function(rate){
  -sum(dexp(x=data.time$time[data.time$event==1 & data.time$tx == 1], rate=rate, log=TRUE))- sum(pexp(q=data.time$time[data.time$event==0 & data.time$tx == 1], lower.tail = FALSE, rate=rate, log=TRUE))
}

(nlminb(start=0.5,objective = exp.likelihood_with_treat,lower=0)$par)
(nlminb(start=0.5,objective = exp.likelihood_with_treat,lower=0)$objective )
```

